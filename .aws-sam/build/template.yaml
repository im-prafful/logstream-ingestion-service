AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Log Ingestion Pipeline using SAM, SQS, and Postgres (Scheduled Polling
  Model).
Parameters:
  PostgresHost:
    Type: String
    Default: logstream-db.czegikcsabng.ap-south-1.rds.amazonaws.com
  PostgresDatabase:
    Type: String
    Default: Logstream_DB
  PostgresUser:
    Type: String
    Default: masterUser
  PostgresPassword:
    Type: String
    Default: Admin$1234
  PostgresPort:
    Type: Number
    Default: 5432
  ExistingQueueUrl:
    Type: String
    Description: The URL of the SQS queue created manually in the console.
    Default: https://sqs.ap-south-1.amazonaws.com/031415497613/SQS_LogIngestion
  ExistingQueueArn:
    Type: String
    Description: The ARN of the SQS queue for IAM permissions.
    Default: arn:aws:sqs:ap-south-1:031415497613:SQS_LogIngestion
Globals:
  Function:
    Runtime: nodejs20.x
    MemorySize: 256
    Timeout: 60
Resources:
  LogProducerFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: LogProducerFunction
      Handler: app.handler
      Policies:
      - Statement:
          Effect: Allow
          Action: sqs:SendMessage
          Resource:
            Ref: ExistingQueueArn
      Environment:
        Variables:
          SQS_QUEUE_URL:
            Ref: ExistingQueueUrl
    Metadata:
      SamResourceId: LogProducerFunction
  LogPipelineFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: LogPipelineFunction
      Handler: app.handler
      VpcConfig:
        SecurityGroupIds:
        - sg-019f671390240930c
        SubnetIds:
        - subnet-0a11c12998ff540e1
        - subnet-065a73345490e0ee8
      Policies:
      - Statement:
          Effect: Allow
          Action:
          - sqs:ReceiveMessage
          - sqs:DeleteMessageBatch
          - sqs:GetQueueAttributes
          Resource:
            Ref: ExistingQueueArn
      - Statement:
          Effect: Allow
          Action:
          - rds:Connect
          Resource: '*'
      Environment:
        Variables:
          SQS_QUEUE_URL:
            Ref: ExistingQueueUrl
          DB_HOST:
            Ref: PostgresHost
          DB_PORT:
            Ref: PostgresPort
          DB_NAME:
            Ref: PostgresDatabase
          DB_USER:
            Ref: PostgresUser
          DB_PASSWORD:
            Ref: PostgresPassword
    Metadata:
      SamResourceId: LogPipelineFunction
